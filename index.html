<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ensinamentos - Viewer</title>
    <!-- Basic styles matching style4.css and typical layout -->
    <style>
        body {
            background-color: #E9FEDA;
            font-family: 'MS PGothic', 'Osaka', sans-serif;
            margin: 0;
            padding: 20px;
            text-align: center;
        }

        /* Sidebar for navigation */
        #sidebar {
            position: fixed;
            left: -300px;
            top: 0;
            bottom: 0;
            width: 300px;
            background: #fff;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.2);
            transition: left 0.3s;
            overflow-y: auto;
            text-align: left;
            z-index: 2000;
            padding: 10px;
        }

        #sidebar.open {
            left: 0;
        }

        #sidebar ul {
            list-style: none;
            padding: 0;
        }

        #sidebar li {
            padding: 5px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            font-size: 0.9em;
        }

        #sidebar li:hover {
            background: #f0f0f0;
        }

        #sidebar li.active {
            background: #e0f0d0;
            font-weight: bold;
        }

        #toggle-sidebar {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 2001;
        }

        /* Replicating the "blockqoute" feel for the content area */
        #main-container {
            background-color: transparent;
            max-width: 800px;
            margin: 0 auto;
            text-align: left;
            transition: margin-left 0.3s;
        }

        /* Typography */
        h1,
        h2,
        h3 {
            font-family: 'HGSeikaishotai-PRO', 'MS Gothic', serif;
            font-weight: bold;
            text-align: center;
            margin-bottom: 20px;
        }

        .header-text {
            text-align: right;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        /* Search Bar emulation */
        .search-bar {
            background-color: #E9FEDA;
            text-align: right;
            padding: 10px;
            margin-bottom: 20px;
        }

        .content-box {
            /* Mimicking <blockquote> style default margins */
            margin: 0 40px;
            line-height: 1.6;
            font-size: 1.1em;
        }

        /* Language Toggle Switch */
        #lang-toggle-container {
            position: fixed;
            top: 10px;
            right: 10px;
            background: white;
            padding: 5px 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }

        #lang-toggle-container select {
            font-size: 14px;
            padding: 2px;
        }

        /* Markdown rendering helper classes */
        .md-h2 {
            font-size: 1.5em;
            font-weight: bold;
            text-align: center;
            margin-top: 30px;
        }

        .md-p {
            margin-bottom: 1em;
            text-align: justify;
        }

        button {
            cursor: pointer;
            padding: 5px 10px;
            font-size: 14px;
        }
    </style>
</head>

<body>

    <button id="toggle-sidebar" onclick="toggleSidebar()">☰ Índice</button>

    <div id="sidebar">
        <h3>Índice Alfabético</h3>
        <input type="text" id="filter-list" placeholder="Filtrar..." onkeyup="renderList()"
            style="width: 90%; margin-bottom: 5px;">
        <div id="alpha-filters" style="margin-bottom: 10px; font-size: 0.8em;">
            <!-- Generated by JS -->
        </div>
        <ul id="list-container"></ul>
    </div>

    <div id="lang-toggle-container">
        <label for="lang-select">Idioma:</label>
        <select id="lang-select" onchange="switchLanguage(this.value)">
            <option value="ptbr">Português</option>
            <option value="jp">日本語 (Japonês)</option>
        </select>
    </div>

    <div id="main-container">
        <!-- Header similar to s260801a.html -->
        <div class="header-text">
            <strong>―― 岡田自観師の論文集 ――</strong><br>
            <span id="doc-date"></span>
        </div>

        <hr>

        <div id="content-area" class="content-box">
            <p style="text-align: center;">Carregando...</p>
        </div>

        <div style="text-align: center; margin-top: 50px;">
            <button onclick="prevTeaching()">Anterior</button>
            <button onclick="nextTeaching()">Próximo</button>
        </div>
    </div>

    <!-- Simple Markdown Parser (or just usage of regex) -->
    <script>
        let allData = [];
        let currentIndex = 0;
        let currentLang = 'ptbr';

        async function init() {
            try {
                // Try to load the main big JSON
                const response = await fetch('Data/teachings_translated.json');
                allData = await response.json();
            } catch (e) { console.log("Error loading main data", e); }

            console.log(`Loaded ${allData.length} items.`);

            // Pre-process titles for sorting
            allData.forEach(item => {
                item._displayTitle = getDisplayTitle(item);
            });

            // SORT ALPHABETICALLY (Portuguese Rule)
            allData.sort((a, b) => {
                return a._displayTitle.localeCompare(b._displayTitle, 'pt-BR', { sensitivity: 'base' });
            });

            generateAlphaButtons();
            renderList();

            // Show first item or random
            loadTeaching(0);
        }

        function generateAlphaButtons() {
            const container = document.getElementById('alpha-filters');
            const alphabet = "#ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
            let html = "";
            alphabet.forEach(letter => {
                html += `<span style="cursor:pointer; margin-right:4px; color:blue;" onclick="filterByLetter('${letter}')">${letter}</span>`;
            });
            html += `<span style="cursor:pointer; margin-right:4px; color:red;" onclick="filterByLetter('')">All</span>`;
            container.innerHTML = html;
        }

        let currentLetterFilter = "";
        function filterByLetter(letter) {
            currentLetterFilter = letter;
            document.getElementById('filter-list').value = ""; // Clear text search
            renderList();
        }

        function getDisplayTitle(item) {
            // Priority 1: Markdown Header in PT Translation
            if (item.content_ptbr) {
                const match = item.content_ptbr.match(/^#+\s+(.*)$/m);
                if (match) return match[1].trim();
            }
            // Priority 2: content_pt string itself if short (titles sometimes are just text?)
            // Fallback: title field
            if (item.title && item.title !== "(Sem Título)") return item.title;

            // Fallback: Japanese Title
            if (item.title_jp) return item.title_jp + " (JP)";

            // Fallback: Filename
            return item.source_file || "Sem Título";
        }

        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            sb.classList.toggle('open');
            const main = document.getElementById('main-container');
            if (sb.classList.contains('open')) {
                // main.style.marginLeft = "300px"; // Optional push
            } else {
                main.style.marginLeft = "0";
            }
        }

        function renderList() {
            const list = document.getElementById('list-container');
            const filter = document.getElementById('filter-list').value.toLowerCase();

            let html = '';
            let count = 0;
            const MAX_ITEMS = 500; // Lazy rendering limit for performance

            for (let i = 0; i < allData.length; i++) {
                const item = allData[i];
                const title = item._displayTitle;

                // Letter Filter
                if (currentLetterFilter) {
                    if (currentLetterFilter === '#') {
                        if (!/^[0-9]/.test(title)) continue;
                    } else {
                        if (!title.toUpperCase().startsWith(currentLetterFilter)) continue;
                    }
                }

                // Text Filter
                if (filter && !title.toLowerCase().includes(filter)) continue;

                const active = i === currentIndex ? 'class="active"' : '';
                html += `<li ${active} onclick="loadTeaching(${i}); toggleSidebar();">${title}</li>`;

                count++;
                if (count > MAX_ITEMS && !filter && !currentLetterFilter) {
                    html += `<li>... (Use o filtro para ver mais) ...</li>`;
                    break;
                }
            }
            list.innerHTML = html;
        }

        function loadTeaching(index) {
            if (index < 0 || index >= allData.length) return;
            currentIndex = index;
            const item = allData[index];
            render(item);

            // Update active state in list if open
            // renderList(); // Expensive to re-render all, better just toggle class
        }

        function render(item) {
            const content = currentLang === 'ptbr' ? (item.content_ptbr || item.content_pt) : item.content_jp;
            let finalContent = content || "(Conteúdo não disponível neste idioma)";

            // Basic Markdown to HTML
            // If it's pure HTML, we trust it. If it's Markdown, key chars: #, *, \n
            if (finalContent.includes('#') || finalContent.includes('\n')) {
                finalContent = finalContent
                    .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                    .replace(/^## (.*$)/gim, '<h2 class="md-h2">$1</h2>')
                    .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                    .replace(/\*\*(.*)\*\*/gim, '<b>$1</b>')
                    .replace(/\n/gim, '<br>');
            }

            document.getElementById('content-area').innerHTML = finalContent;
            document.getElementById('doc-date').innerText = item.source_file || "";
        }

        function switchLanguage(lang) {
            currentLang = lang;
            render(allData[currentIndex]);
        }

        function nextTeaching() {
            loadTeaching(currentIndex + 1);
        }

        function prevTeaching() {
            loadTeaching(currentIndex - 1);
        }

        window.onload = init;
    </script>
</body>

</html>