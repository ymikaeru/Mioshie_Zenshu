<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minha Publica√ß√£o - Ensinamentos</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --bg-primary: #fafafa;
            --bg-secondary: #ffffff;
            --text-primary: #1a1a1a;
            --text-secondary: #6b6b6b;
            --text-muted: #9a9a9a;
            --accent: #6b5b95;
            --accent-light: #f0edf5;
            --border-light: #ebebeb;
            --border-medium: #d4d4d4;
            --shadow-soft: 0 1px 3px rgba(0, 0, 0, 0.04);
            --shadow-medium: 0 4px 12px rgba(0, 0, 0, 0.06);
            --radius: 8px;
            --transition: 0.2s ease;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            font-size: 15px;
            -webkit-font-smoothing: antialiased;
        }

        /* Header - Minimal */
        .header {
            background: var(--bg-secondary);
            padding: 1.25rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-light);
        }

        .header h1 {
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--text-primary);
            letter-spacing: -0.02em;
        }

        .header-nav {
            display: flex;
            gap: 1.5rem;
        }

        .header-nav a {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.875rem;
            font-weight: 400;
            transition: color var(--transition);
        }

        .header-nav a:hover {
            color: var(--accent);
        }

        /* Main Content */
        .container {
            max-width: 960px;
            margin: 0 auto;
            padding: 3rem 2rem;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 6rem 2rem;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1.5rem;
            opacity: 0.4;
        }

        .empty-state h2 {
            font-size: 1.25rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .empty-state p {
            color: var(--text-secondary);
            margin-bottom: 2rem;
            font-size: 0.95rem;
        }

        .empty-state a {
            color: var(--accent);
            text-decoration: none;
            font-weight: 500;
        }

        .empty-state a:hover {
            text-decoration: underline;
        }

        /* Publication Selector */
        .pub-selector {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 3rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid var(--border-light);
        }

        .pub-selector label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
            font-weight: 500;
        }

        .pub-selector select {
            padding: 0.6rem 1rem;
            border: 1px solid var(--border-medium);
            border-radius: var(--radius);
            font-size: 0.9rem;
            background: var(--bg-secondary);
            cursor: pointer;
            min-width: 220px;
            font-family: inherit;
            color: var(--text-primary);
        }

        .pub-selector select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .pub-actions {
            margin-left: auto;
            display: flex;
            gap: 0.5rem;
        }

        /* Buttons */
        .btn {
            padding: 0.6rem 1.25rem;
            border: none;
            border-radius: var(--radius);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition);
            font-family: inherit;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: #244a38;
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-medium);
        }

        .btn-secondary:hover {
            background: var(--bg-primary);
            border-color: var(--text-secondary);
        }

        .btn-danger {
            background: transparent;
            color: #b44;
            border: 1px solid #e5c5c5;
        }

        .btn-danger:hover {
            background: #fdf5f5;
            border-color: #b44;
        }

        /* Settings Panel */
        .settings-panel {
            background: var(--bg-secondary);
            padding: 1.5rem;
            border-radius: var(--radius);
            border: 1px solid var(--border-light);
            margin-bottom: 2rem;
        }

        .settings-row {
            display: flex;
            gap: 3rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .setting-group {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .setting-group label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
            font-weight: 500;
        }

        .setting-group select {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border-medium);
            border-radius: var(--radius);
            font-size: 0.875rem;
            background: var(--bg-secondary);
            font-family: inherit;
        }

        .setting-group input[type="range"] {
            width: 100px;
            accent-color: var(--accent);
        }

        .font-size-display {
            font-size: 0.875rem;
            color: var(--text-secondary);
            min-width: 35px;
        }

        /* Articles List */
        .articles-section {
            margin-bottom: 3rem;
        }

        .section-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
            font-weight: 500;
            margin-bottom: 1rem;
        }

        .articles-list {
            display: flex;
            flex-direction: column;
            gap: 1px;
            background: var(--border-light);
            border-radius: var(--radius);
            overflow: hidden;
        }

        .article-card {
            background: var(--bg-secondary);
            padding: 1rem 1.25rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            transition: background var(--transition);
            cursor: pointer;
        }

        .article-card:hover {
            background: #f5f8f6;
        }

        .article-number {
            width: 24px;
            height: 24px;
            background: var(--bg-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            color: var(--text-muted);
            flex-shrink: 0;
        }

        .article-content {
            flex: 1;
            min-width: 0;
        }

        .article-title {
            font-weight: 500;
            font-size: 0.95rem;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .article-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .article-actions {
            display: flex;
            gap: 0.25rem;
            opacity: 0;
            transition: opacity var(--transition);
        }

        .article-card:hover .article-actions {
            opacity: 1;
        }

        .btn-icon {
            width: 28px;
            height: 28px;
            border: none;
            background: transparent;
            border-radius: var(--radius);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            transition: all var(--transition);
            font-size: 0.9rem;
        }

        .btn-icon:hover {
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .btn-icon.danger:hover {
            background: #fdf5f5;
            color: #b44;
        }

        /* Print Preview */
        .print-preview {
            background: var(--bg-secondary);
            border-radius: var(--radius);
            border: 1px solid var(--border-light);
            overflow: hidden;
        }

        .print-preview-header {
            padding: 1rem 1.5rem;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .print-preview-header h3 {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
            font-weight: 500;
        }

        .print-preview-content {
            padding: 3rem;
            max-height: 600px;
            overflow-y: auto;
        }

        /* Preview Styles */
        .print-cover {
            text-align: center;
            padding: 6rem 3rem;
            border-bottom: none;
            margin-bottom: 3rem;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .print-cover::before {
            content: '';
            position: absolute;
            top: 3rem;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--accent), transparent);
        }

        .print-cover::after {
            content: '';
            position: absolute;
            bottom: 3rem;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--accent), transparent);
        }

        .print-cover h1 {
            font-size: 2.5rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
            letter-spacing: -0.02em;
            line-height: 1.2;
        }

        .print-cover .subtitle {
            color: var(--text-muted);
            font-size: 1rem;
            margin-bottom: 2rem;
        }

        .print-cover .article-count {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--accent-light);
            color: var(--accent);
            padding: 0.75rem 1.5rem;
            border-radius: 50px;
            font-weight: 500;
            font-size: 0.95rem;
        }

        .print-cover .article-count svg {
            width: 18px;
            height: 18px;
        }

        .print-cover .date-info {
            margin-top: 1rem;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .print-index {
            margin-bottom: 3rem;
            padding-bottom: 3rem;
            border-bottom: 1px solid var(--border-light);
        }

        .print-index h2 {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
            font-weight: 500;
            margin-bottom: 1.5rem;
        }

        .print-index-item {
            display: flex;
            justify-content: space-between;
            padding: 0.6rem 0;
            border-bottom: 1px dotted var(--border-light);
            font-size: 0.9rem;
        }

        .print-index-item:last-child {
            border-bottom: none;
        }

        .print-article {
            margin-bottom: 3rem;
            padding-bottom: 3rem;
            border-bottom: 1px solid var(--border-light);
        }

        .print-article:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .print-article-header {
            margin-bottom: 1.5rem;
        }

        .print-article-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            border-bottom: 2px solid var(--accent);
            padding-bottom: 0.5rem;
        }

        .print-article-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .print-article-content {
            line-height: 1.8;
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .print-article-content p {
            margin-bottom: 1rem;
        }

        /* Hide duplicate title in content (first h1/h2/h3) */
        .print-article-content>h1:first-child,
        .print-article-content>h2:first-child,
        .print-article-content>h3:first-child,
        .print-article-content>.translated-content>h2:first-child,
        .print-article-content>.translated-content>h3:first-child {
            display: none;
        }

        .print-article-content h1,
        .print-article-content h2,
        .print-article-content h3 {
            color: var(--text-primary);
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
        }

        .print-article-tags {
            margin-top: 1.5rem;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Loading indicator */
        .loading-indicator {
            color: var(--text-muted);
            font-style: italic;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .loading-spinner {
            width: 12px;
            height: 12px;
            border: 2px solid var(--border-light);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Article Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-window {
            background: var(--bg-secondary);
            width: 90%;
            max-width: 1000px;
            max-height: 85vh;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            transform: translateY(20px);
            transition: transform 0.3s;
        }

        .modal-overlay.active .modal-window {
            transform: translateY(0);
        }

        .modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
        }

        .modal-header-info {
            flex: 1;
            min-width: 0;
        }

        .modal-title {
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .modal-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--bg-primary);
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 1.25rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .modal-close:hover {
            background: var(--border-light);
            color: var(--text-primary);
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
        }

        .btn-icon-sm {
            width: 28px;
            height: 28px;
            border: 1px solid var(--border-medium);
            background: var(--bg-primary);
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .btn-icon-sm:hover {
            background: var(--accent-light);
            border-color: var(--accent);
            color: var(--accent);
        }

        .modal-content {
            line-height: 1.9;
            color: var(--text-secondary);
        }

        .modal-content p {
            margin-bottom: 1rem;
        }

        .modal-content h1,
        .modal-content h2,
        .modal-content h3 {
            color: var(--text-primary);
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
        }

        .modal-content h1 {
            font-size: 1.4rem;
        }

        .modal-content h2 {
            font-size: 1.2rem;
        }

        .modal-content h3 {
            font-size: 1.1rem;
        }

        .modal-tags {
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-light);
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .modal-tag {
            background: var(--accent-light);
            color: var(--accent);
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            border-radius: 4px;
        }

        /* Print Styles */
        @media print {
            body {
                background: white;
                font-size: var(--print-font-size, 12pt);
            }

            .header,
            .pub-selector,
            .settings-panel,
            .btn,
            .article-number,
            .article-actions,
            .print-preview-header,
            .pub-actions,
            .articles-section,
            .modal-overlay {
                display: none !important;
            }

            .container {
                max-width: 100%;
                padding: 0;
            }

            .print-preview {
                border: none;
                border-radius: 0;
            }

            .print-preview-content {
                max-height: none;
                padding: 0;
            }

            .print-cover {
                page-break-after: always;
                padding: 6cm 2cm;
            }

            .print-cover h1 {
                font-size: 28pt;
            }

            .print-index {
                page-break-after: always;
            }

            .print-article {
                page-break-before: always;
            }

            .print-article:first-of-type {
                page-break-before: avoid;
            }

            .print-article-content {
                text-align: var(--print-text-align, justify);
            }
        }

        /* Empty list state */
        .empty-list {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .empty-list a {
            color: var(--accent);
            text-decoration: none;
        }
    </style>
</head>

<body>

    <div class="header">
        <h1>Publica√ß√£o</h1>
        <div class="header-nav">
            <a href="advanced_search.html">‚Üê Buscar Artigos</a>
            <a href="2.html">Menu Principal</a>
        </div>
    </div>

    <div class="container">
        <!-- Empty State -->
        <div id="emptyState" class="empty-state" style="display: none;">
            <div class="empty-state-icon">üìÑ</div>
            <h2>Nenhuma publica√ß√£o</h2>
            <p>Crie uma publica√ß√£o e adicione artigos na <a href="advanced_search.html">Busca Avan√ßada</a>.</p>
            <button class="btn btn-primary" onclick="createNewPublication()" style="margin-top: 1rem;">
                + Criar Publica√ß√£o
            </button>
        </div>

        <!-- Publication Content -->
        <div id="publicationContent" style="display: none;">
            <!-- Selector -->
            <div class="pub-selector">
                <label>Publica√ß√£o</label>
                <select id="pubSelect" onchange="loadPublication()"></select>
                <button class="btn btn-icon" onclick="renameCurrentPublication()" title="Renomear publica√ß√£o"
                    style="margin-left: 0.5rem;">
                    ‚úèÔ∏è
                </button>
                <button class="btn btn-primary" onclick="createNewPublication()" style="margin-left: 0.25rem;">
                    + Nova
                </button>
                <div class="pub-actions">
                    <button class="btn btn-secondary" onclick="loadAllContent()">
                        Carregar Conte√∫dos
                    </button>
                    <button class="btn btn-danger" onclick="deleteCurrentPublication()">
                        Excluir
                    </button>
                </div>
            </div>

            <!-- Settings -->
            <div class="settings-panel">
                <div class="settings-row">
                    <div class="setting-group">
                        <label>Alinhamento</label>
                        <select id="textAlign" onchange="updateSettings()">
                            <option value="justify">Justificado</option>
                            <option value="left">Esquerda</option>
                            <option value="center">Centro</option>
                            <option value="right">Direita</option>
                        </select>
                    </div>
                    <div class="setting-group">
                        <label>Fonte</label>
                        <input type="range" id="fontSize" min="12" max="24" value="16" onchange="updateSettings()">
                        <span class="font-size-display" id="fontSizeDisplay">16px</span>
                    </div>
                    <div style="margin-left: auto;">
                        <button class="btn btn-primary" onclick="printPublication()">
                            Imprimir
                        </button>
                    </div>
                </div>
            </div>

            <!-- Articles Section -->
            <div class="articles-section">
                <div class="section-title">Artigos (clique para visualizar)</div>
                <div id="articlesList" class="articles-list">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Print Preview -->
            <div class="print-preview">
                <div class="print-preview-header">
                    <h3>Visualiza√ß√£o de Impress√£o</h3>
                </div>
                <div class="print-preview-content" id="printPreview">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- Article Modal -->
    <div class="modal-overlay" id="articleModal">
        <div class="modal-window">
            <div class="modal-header">
                <div class="modal-header-info">
                    <div class="modal-title" id="modalTitle">T√≠tulo do Artigo</div>
                    <div class="modal-meta" id="modalMeta">Categoria ¬∑ Data ¬∑ Fonte</div>
                </div>
                <div class="modal-controls"
                    style="display: flex; align-items: center; gap: 0.5rem; margin-right: 1rem;">
                    <button class="btn-icon-sm" onclick="changeModalFontSize(-1)" title="Diminuir fonte">A-</button>
                    <span id="modalFontDisplay"
                        style="font-size: 0.8rem; color: var(--text-muted); min-width: 35px; text-align: center;">16px</span>
                    <button class="btn-icon-sm" onclick="changeModalFontSize(1)" title="Aumentar fonte">A+</button>
                </div>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="modal-content" id="modalContent">
                    Carregando...
                </div>
                <div class="modal-tags" id="modalTags"></div>
            </div>
        </div>
    </div>

    <script src="scripts/favorites.js"></script>
    <script>
        let currentPubId = null;
        let fullContentCache = {};  // Cache for loaded full content

        document.addEventListener('DOMContentLoaded', () => {
            loadPublicationList();
        });

        // Close modal on overlay click
        document.getElementById('articleModal').addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                closeModal();
            }
        });

        // Close modal on ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });

        function loadPublicationList() {
            const publications = FavoritesManager.getPublications();
            const pubList = Object.values(publications);
            const select = document.getElementById('pubSelect');
            const emptyState = document.getElementById('emptyState');
            const content = document.getElementById('publicationContent');

            if (pubList.length === 0) {
                emptyState.style.display = 'block';
                content.style.display = 'none';
                return;
            }

            emptyState.style.display = 'none';
            content.style.display = 'block';

            select.innerHTML = pubList.map(p =>
                `<option value="${p.id}">${p.name} (${p.items.length})</option>`
            ).join('');

            currentPubId = pubList[0].id;
            loadPublication();
        }

        function createNewPublication() {
            const name = prompt('Nome da nova publica√ß√£o:');
            if (!name || !name.trim()) return;

            const pub = FavoritesManager.createPublication(name.trim());
            currentPubId = pub.id;
            loadPublicationList();

            // Select the new publication
            const select = document.getElementById('pubSelect');
            select.value = pub.id;
            loadPublication();
        }

        function renameCurrentPublication() {
            if (!currentPubId) return;

            const pub = FavoritesManager.getPublication(currentPubId);
            if (!pub) return;

            const newName = prompt('Novo nome da publica√ß√£o:', pub.name);
            if (!newName || !newName.trim() || newName.trim() === pub.name) return;

            FavoritesManager.renamePublication(currentPubId, newName.trim());
            loadPublicationList();

            // Re-select current publication
            const select = document.getElementById('pubSelect');
            select.value = currentPubId;
            loadPublication();
        }

        function loadPublication() {
            const select = document.getElementById('pubSelect');
            currentPubId = select.value;

            const pub = FavoritesManager.getPublication(currentPubId);
            if (!pub) return;

            document.getElementById('textAlign').value = pub.settings?.textAlign || 'justify';
            document.getElementById('fontSize').value = parseInt(pub.settings?.fontSize) || 16;
            document.getElementById('fontSizeDisplay').textContent = (pub.settings?.fontSize || '16px');

            renderArticlesList(pub);
            renderPrintPreview(pub);
        }

        function renderArticlesList(pub) {
            const container = document.getElementById('articlesList');

            if (pub.items.length === 0) {
                container.innerHTML = `
                    <div class="empty-list">
                        Nenhum artigo. <a href="advanced_search.html">Adicione artigos</a>.
                    </div>
                `;
                return;
            }

            container.innerHTML = pub.items.map((item, index) => `
                <div class="article-card" data-id="${item.id}" onclick="openArticleModal('${item.id}')">
                    <div class="article-number">${index + 1}</div>
                    <div class="article-content">
                        <div class="article-title">${item.title}</div>
                        <div class="article-meta">
                            ${item.category ? `<span>${item.category}</span>` : ''}
                            ${item.date ? `<span>${item.date}</span>` : ''}
                            ${item.source ? `<span>${item.source}</span>` : ''}
                        </div>
                    </div>
                    <div class="article-actions">
                        ${index > 0 ? `<button class="btn-icon" onclick="event.stopPropagation(); moveArticle('${item.id}', -1)" title="Mover para cima">‚Üë</button>` : ''}
                        ${index < pub.items.length - 1 ? `<button class="btn-icon" onclick="event.stopPropagation(); moveArticle('${item.id}', 1)" title="Mover para baixo">‚Üì</button>` : ''}
                        <button class="btn-icon danger" onclick="event.stopPropagation(); removeArticle('${item.id}')" title="Remover">√ó</button>
                    </div>
                </div>
            `).join('');
        }

        // Open article modal
        async function openArticleModal(articleId) {
            const pub = FavoritesManager.getPublication(currentPubId);
            const article = pub?.items.find(item => item.id === articleId);
            if (!article) return;

            const modal = document.getElementById('articleModal');
            const titleEl = document.getElementById('modalTitle');
            const metaEl = document.getElementById('modalMeta');
            const contentEl = document.getElementById('modalContent');
            const tagsEl = document.getElementById('modalTags');

            titleEl.textContent = article.title;
            metaEl.textContent = [article.category, article.date, article.source].filter(Boolean).join(' ¬∑ ');
            contentEl.innerHTML = '<div class="loading-indicator"><div class="loading-spinner"></div> Carregando conte√∫do...</div>';

            if (article.tags && article.tags.length > 0) {
                tagsEl.innerHTML = article.tags.map(t => `<span class="modal-tag">${t}</span>`).join('');
            } else {
                tagsEl.innerHTML = '';
            }

            modal.classList.add('active');
            applyModalFontSize();

            // Load full content
            const fullContent = await loadFullContent(article);
            contentEl.innerHTML = fullContent;
            applyModalFontSize();
        }

        function closeModal() {
            document.getElementById('articleModal').classList.remove('active');
        }

        // Modal font size control
        let modalFontSize = parseInt(localStorage.getItem('modalFontSize')) || 16;

        function changeModalFontSize(delta) {
            modalFontSize = Math.max(12, Math.min(28, modalFontSize + delta * 2));
            localStorage.setItem('modalFontSize', modalFontSize);

            const contentEl = document.getElementById('modalContent');
            const displayEl = document.getElementById('modalFontDisplay');

            if (contentEl) contentEl.style.fontSize = modalFontSize + 'px';
            if (displayEl) displayEl.textContent = modalFontSize + 'px';
        }

        // Apply saved font size when modal opens
        function applyModalFontSize() {
            const contentEl = document.getElementById('modalContent');
            const displayEl = document.getElementById('modalFontDisplay');

            if (contentEl) contentEl.style.fontSize = modalFontSize + 'px';
            if (displayEl) displayEl.textContent = modalFontSize + 'px';
        }

        // Load full content for an article
        async function loadFullContent(article) {
            // Check cache first
            if (fullContentCache[article.id]) {
                return fullContentCache[article.id];
            }

            // Try to load from URL
            if (article.url) {
                try {
                    const response = await fetch(article.url);
                    if (response.ok) {
                        const html = await response.text();

                        // Parse HTML to extract content
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');

                        // Try different content selectors
                        let content = doc.querySelector('.content-body')?.innerHTML
                            || doc.querySelector('.teaching-content')?.innerHTML
                            || doc.querySelector('article')?.innerHTML
                            || doc.querySelector('.main-content')?.innerHTML
                            || doc.querySelector('main')?.innerHTML
                            || doc.body?.innerHTML;

                        if (content) {
                            // Clean up the content
                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = content;

                            // Remove scripts, styles, nav elements, and other unwanted content
                            tempDiv.querySelectorAll(`
                                script, style, nav, header, footer, .sidebar,
                                .view-controls, .btn-view, .language-toggle,
                                form, input, button:not(.modal-close),
                                [class*="search"], [class*="help"], [id*="search"],
                                h1:first-of-type, .title:first-of-type,
                                .lang-toggle, .toggle-bar, .compare-view,
                                table:has(input), div:has(> input[type="text"])
                            `).forEach(el => el.remove());

                            // Also remove elements containing Japanese search text
                            tempDiv.querySelectorAll('*').forEach(el => {
                                if (el.textContent.includes('Âæ°Êïô„ÅàÊ§úÁ¥¢') ||
                                    el.textContent.includes('Ë≥áÊñôÊ§úÁ¥¢') ||
                                    el.textContent.includes('Ê§úÁ¥¢') && el.tagName === 'BUTTON' ||
                                    el.textContent === 'help') {
                                    el.remove();
                                }
                            });

                            // Remove first h1, h2, or h3 to avoid duplicate titles
                            // Always remove the first heading as we already display title separately
                            const firstHeading = tempDiv.querySelector('h1, h2, h3');
                            if (firstHeading) {
                                firstHeading.remove();
                            }

                            // Also check for headings within translated-content div
                            const translatedContent = tempDiv.querySelector('.translated-content');
                            if (translatedContent) {
                                const innerHeading = translatedContent.querySelector('h2:first-child, h3:first-child');
                                if (innerHeading) innerHeading.remove();
                            }

                            content = tempDiv.innerHTML;
                            fullContentCache[article.id] = content;
                            return content;
                        }
                    }
                } catch (error) {
                    console.log('Could not load from URL:', error);
                }
            }

            // Fallback: use content_snippet and convert markdown
            if (article.content_snippet) {
                let content = article.content_snippet;

                // Convert markdown to HTML if marked is available
                if (typeof marked !== 'undefined') {
                    content = marked.parse(content);
                } else {
                    // Basic markdown conversion
                    content = simpleMarkdownToHtml(content);
                }

                fullContentCache[article.id] = content;
                return content;
            }

            return '<em>Conte√∫do n√£o dispon√≠vel</em>';
        }

        // Simple markdown to HTML converter (fallback)
        function simpleMarkdownToHtml(text) {
            return text
                .replace(/^### (.+)$/gm, '<h3>$1</h3>')
                .replace(/^## (.+)$/gm, '<h2>$1</h2>')
                .replace(/^# (.+)$/gm, '<h1>$1</h1>')
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.+?)\*/g, '<em>$1</em>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/^/, '<p>')
                .replace(/$/, '</p>');
        }

        // Load all content for print preview
        async function loadAllContent() {
            const pub = FavoritesManager.getPublication(currentPubId);
            if (!pub) return;

            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '<div class="loading-spinner" style="display:inline-block;width:12px;height:12px;"></div> Carregando...';

            for (const item of pub.items) {
                await loadFullContent(item);
            }

            btn.disabled = false;
            btn.textContent = 'Carregar Conte√∫dos';

            renderPrintPreview(pub);
            alert('Todos os conte√∫dos foram carregados!');
        }

        function renderPrintPreview(pub) {
            const container = document.getElementById('printPreview');
            const settings = pub.settings || {};

            const fontSize = settings.fontSize || '16px';
            const textAlign = settings.textAlign || 'justify';

            let html = `
                <div class="print-cover">
                    <h1>${pub.name}</h1>
                    <div class="subtitle">Compila√ß√£o de Ensinamentos</div>
                    <div class="article-count">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                            <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                        </svg>
                        ${pub.items.length} artigo${pub.items.length !== 1 ? 's' : ''}
                    </div>
                    <div class="date-info">
                        Criado em ${new Date(pub.createdAt).toLocaleDateString('pt-BR', { year: 'numeric', month: 'long', day: 'numeric' })}
                    </div>
                </div>

                <div class="print-index">
                    <h2>√çndice</h2>
                    ${pub.items.map((item, i) => `
                        <div class="print-index-item">
                            <span>${i + 1}. ${item.title}</span>
                        </div>
                    `).join('')}
                </div>

                ${pub.items.map((item, i) => {
                // Use cached full content or snippet
                let content = fullContentCache[item.id] || item.content_snippet || '<em>Clique em "Carregar Conte√∫dos" para carregar o texto completo</em>';

                // Convert markdown if it looks like markdown and marked is available
                if (!fullContentCache[item.id] && item.content_snippet && typeof marked !== 'undefined') {
                    content = marked.parse(item.content_snippet);
                }

                return `
                    <div class="print-article">
                        <div class="print-article-header">
                            <div class="print-article-title">${item.title}</div>
                            <div class="print-article-meta">
                                ${[item.date, item.source, item.category].filter(Boolean).join(' ¬∑ ')}
                            </div>
                        </div>
                        <div class="print-article-content" style="font-size: ${fontSize}; text-align: ${textAlign};">
                            ${content}
                        </div>
                        ${item.tags && item.tags.length > 0 ? `
                            <div class="print-article-tags">
                                ${item.tags.join(' ¬∑ ')}
                            </div>
                        ` : ''}
                    </div>
                `}).join('')}
            `;

            container.innerHTML = html;
        }

        function updateSettings() {
            const fontSize = document.getElementById('fontSize').value + 'px';
            const textAlign = document.getElementById('textAlign').value;

            document.getElementById('fontSizeDisplay').textContent = fontSize;

            FavoritesManager.updatePublicationSettings(currentPubId, { fontSize, textAlign });

            const pub = FavoritesManager.getPublication(currentPubId);
            if (pub) renderPrintPreview(pub);
        }

        function moveArticle(articleId, direction) {
            const pub = FavoritesManager.getPublication(currentPubId);
            if (!pub) return;

            const currentIndex = pub.items.findIndex(item => item.id === articleId);
            const newIndex = currentIndex + direction;

            if (newIndex >= 0 && newIndex < pub.items.length) {
                FavoritesManager.reorderItems(currentPubId, currentIndex, newIndex);
                loadPublication();
            }
        }

        function removeArticle(articleId) {
            if (confirm('Remover este artigo?')) {
                FavoritesManager.removeFromPublication(currentPubId, articleId);
                loadPublication();
                loadPublicationList();
            }
        }

        function deleteCurrentPublication() {
            const pub = FavoritesManager.getPublication(currentPubId);
            if (!pub) return;

            if (confirm(`Excluir "${pub.name}"?`)) {
                FavoritesManager.deletePublication(currentPubId);
                loadPublicationList();
            }
        }

        function printPublication() {
            const pub = FavoritesManager.getPublication(currentPubId);
            if (!pub) return;

            document.documentElement.style.setProperty('--print-font-size', pub.settings?.fontSize || '16px');
            document.documentElement.style.setProperty('--print-text-align', pub.settings?.textAlign || 'justify');

            window.print();
        }
    </script>
</body>

</html>