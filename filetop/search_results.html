<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <title>Resultados da Pesquisa</title>
    <link href="../style1.css" rel="stylesheet" type="text/css">
    <style>
        #status {
            text-align: center;
            margin: 20px;
            color: #5D6D7E;
        }

        .highlight {
            background-color: #fff3cd;
            font-weight: bold;
        }
    </style>
    <script>
        const TERM_MAPPING = {
            '栄光': 'Eikou',
            '救世': 'Kyusei',
            '光明世界': 'Koumyou Sekai',
            '地上天国': 'Chijo Tengoku',
            '東方の光': 'Touhou no Hikari',
            '明日の医術': 'Ashita no Ijutsu',
            '天国の福音': 'Tengoku no Fukuin',
            '文明の創造': 'Bunmei no Souzou',
            '医学革命の書': 'Igaku Kakumei no Sho',
            '全集': 'Zenshu',
            '光への道': 'Hikari e no Michi',
            '霊界叢談': 'Reikai Soudan',
            'アメリカを救う': 'America wo Sukuu',
            '観音の光': 'Kannon no Hikari',
            '日本医術講義録': 'Nihon Ijutsu Kougiroku',
            '講話': 'Kouwa',
            '御垂示': 'Gosuiji',
            '号': ' Gou',
            '編': ' Hen',
            '書': ' Sho',
            '版': ' Ban',
            '昭和': 'Showa ',
            '年': ' Nen',
            '月': ' Gatsu',
            '日': ' Nichi',
            '未発表': 'Mihappyou',
            '執筆': 'Shippitsu',
            '付録': 'Furoku',
            '再版': 'Saiban',
            '初版': 'Shohan',
            '読売新聞': 'Yomiuri Shimbun',
            '岡田茂吉': 'Okada Mokichi',
            '結核問題と其解決策': 'Kekkaku Mondai to Sono Kaiketsusaku',
            '新日本医術': 'Shin Nihon Ijutsu',
            '世界救世教': 'Sekai Kyuseikyo',
            '奇蹟集': 'Kisekishu',
            '広告文': 'Kokokubun',
            '新稿': 'Shinko',
            // Portuguese Mappings
            'A Medicina do Amanhã': 'Ashita no Ijutsu',
            'Coletânea de Teses do Mestre Okada Jikan': 'Okada Jikan Shi Ronbunshu',
            'Coletânea de Ensaios do Mestre Jikan Okada': 'Okada Jikan Shi Ronbunshu',
            'Ensaios de Mestre Jikan Okada': 'Okada Jikan Shi Ronbunshu',
            'A Questão da Tuberculose e sua Solução': 'Kekkaku Mondai to Sono Kaiketsusaku',
            'O Problema da Tuberculose e sua Solução': 'Kekkaku Mondai to Sono Kaiketsusaku',
            'Livro da Nova Arte Médica Japonesa': 'Shin Nihon Ijutsu',
            'Nova Arte Médica Japonesa': 'Shin Nihon Ijutsu',
            'Palestras de Kannon': 'Kannon Koza',
            'O Movimento de Kannon e sua Declaração': 'Kannon Undo to Sono Sengen',
            'Crônicas de uma Peregrinação Sagrada': 'Seichi Junrei Kiroku',
            'Relatos de Graças': 'Kiseki Shu',
            'Luz da Sabedoria Divina': 'Hikari no Chie',
            'Curso de Johrei': 'Jorei Koza',
            'Guia de Difusão': 'Fukyu no Tebiki',
            'Evangelho do Céu': 'Tengoku no Fukuin',
            'Criação da Civilização': 'Bunmei no Sozo',
            'Alicerce do Paraíso': 'Chijo Tengoku',
            'A Face da Verdade': 'Shinjitsu no Gao',
            'Jornal Eikou': 'Eikou',
            'Jornal Kyusei': 'Kyusei',
            'Jornal Hikari': 'Hikari',
            'O Pão Nosso de Cada Dia': 'Hibi no Kate'
        };

        function translateSource(text) {
            if (!text) return text;
            let translated = text;
            // Sort keys by length descending
            const sortedKeys = Object.keys(TERM_MAPPING).sort((a, b) => b.length - a.length);

            for (const key of sortedKeys) {
                if (translated.includes(key)) {
                    // Global replace
                    translated = translated.split(key).join(TERM_MAPPING[key]);
                }
            }
            return translated;
        }

        async function performSearch() {
            const params = new URLSearchParams(window.location.search);
            const query = params.get('query') || '';
            const indexType = params.get('index') || ''; // '' = teachings, 'shiryo' = materials

            const statusEl = document.getElementById('status');
            const resultsBody = document.getElementById('results-body');
            const queryDisplay = document.getElementById('query-display');

            if (!query) {
                statusEl.textContent = "Por favor, digite um termo para pesquisar.";
                return;
            }

            queryDisplay.textContent = query;
            statusEl.textContent = "Pesquisando...";

            try {
                // Fetch the main data
                const response = await fetch('../Data/teachings_translated.json');
                if (!response.ok) throw new Error("Falha ao carregar dados.");
                const data = await response.json();

                // Simplify terms for search
                const terms = query.toLowerCase().split(/\s+/).filter(t => t.length > 0);

                const results = data.filter(item => {
                    // Filter based on index type if necessary (assuming data has some type field? 
                    // reusing the logic from main viewer, usually we search all)
                    // For now, let's search everything as requested.

                    const title = (item.title || '').toLowerCase();
                    const content = (item.content_ptbr || item.content_pt || '').toLowerCase();
                    const source = (item.source || '').toLowerCase();
                    const date = (item.date || '').toLowerCase();

                    // Check if ALL terms match at least one field
                    return terms.every(term =>
                        title.includes(term) ||
                        content.includes(term) ||
                        source.includes(term) ||
                        date.includes(term)
                    );
                });

                statusEl.textContent = `Encontrados ${results.length} resultados.`;

                // Clear table
                resultsBody.innerHTML = '';

                if (results.length === 0) {
                    resultsBody.innerHTML = '<tr><td colspan="3" align="center">Nenhum resultado encontrado.</td></tr>';
                    return;
                }

                // Render Results
                results.forEach(item => {
                    const row = document.createElement('tr');

                    // Determine Link
                    // Similar logic to update_static_nav.py or viewer.html
                    // We need relative path from filetop/
                    // The json source_file is absolute or relative to base?
                    // Usually strict path map is better, but let's try assuming relative if simple
                    // JSON 'link' isn't stored, 'source_file' is.
                    // We might need to map it. 

                    // Actually, let's check one item structure in json to be sure about linking.
                    // Assuming source_file is relative to the project root.
                    // We are in filetop/ so we go ../ + source_file

                    /* item.source_file example: "search1/a/aaiga1.html" */
                    let link = "#";
                    let displayTitle = item.title;

                    // Specific logic: If title is missing or looks like a filename (no spaces, ends in numbers?), try to extract from content
                    // Also older entries might not have title field.
                    // Try to extract absolute first header from content
                    const content = item.content_ptbr || item.content_pt || '';
                    if (!displayTitle || /^[a-z0-9]+$/i.test(displayTitle)) {
                        const match = content.match(/^#+\s+(.+)$/m);
                        if (match) {
                            displayTitle = match[1].trim();
                        }
                    }

                    // Fallback to filename if still nothing
                    if (!displayTitle && item.source_file) {
                        displayTitle = item.source_file.split('/').pop().replace('.html', '');
                    }

                    const romajiSource = translateSource(item.source || ''); // Ensure not undefined
                    const romajiTitle = translateSource(displayTitle);

                    row.innerHTML = `
                        <td><a href="${link}" target="main">${romajiTitle || '(Sem Título)'}</a></td>
                        <td>${romajiSource}</td>
                        <td align="center">${item.date || ''}</td>
                    `;
                    resultsBody.appendChild(row);
                });

            } catch (e) {
                console.error(e);
                statusEl.textContent = "Erro ao realizar a pesquisa: " + e.message;
            }
        }

        window.onload = performSearch;
    </script>
</head>

<body bgcolor="#E9FEDA">
    <div align="center">
        <h1>Resultados da Pesquisa: <span id="query-display"></span></h1>
        <div id="status">Iniciando...</div>

        <table bgcolor="#EFFFE6" border="1" bordercolor="#C0C0C0" bordercolordark="#C0C0C0" bordercolorlight="#E9FEDA"
            cellpadding="2" cellspacing="0" width="100%">
            <thead>
                <tr>
                    <td bgcolor="#008080" width="50%">
                        <p align="center">
                            <font color="#FFFFFF">TÍTULO</font>
                        </p>
                    </td>
                    <td bgcolor="#008080" width="30%">
                        <p align="center">
                            <font color="#FFFFFF">FONTE</font>
                        </p>
                    </td>
                    <td align="center" bgcolor="#008080" width="20%">
                        <p align="center">
                            <font color="#FFFFFF" size="3">DATA</font>
                        </p>
                    </td>
                </tr>
            </thead>
            <tbody id="results-body">
                <!-- Data will be injected here -->
            </tbody>
        </table>
    </div>
</body>

</html>